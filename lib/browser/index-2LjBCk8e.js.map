{"version":3,"file":"index-2LjBCk8e.js","sources":["../../../node_modules/@emotion-icons/material-outlined/InsertChart/InsertChart.esm.js","../../../node_modules/@emotion-icons/material-outlined/TableChart/TableChart.esm.js","../../../streamlit/frontend/lib/src/components/elements/ArrowVegaLiteChart/useVegaElementPreprocessor.ts","../../../streamlit/frontend/lib/src/components/elements/ArrowVegaLiteChart/arrowUtils.ts","../../../streamlit/frontend/lib/src/components/elements/ArrowVegaLiteChart/useVegaLiteSelections.ts","../../../streamlit/frontend/lib/src/components/elements/ArrowVegaLiteChart/useVegaEmbed.ts","../../../streamlit/frontend/lib/src/components/elements/ArrowVegaLiteChart/ArrowVegaLiteChart.tsx"],"sourcesContent":["import _extends from \"@babel/runtime/helpers/extends\";\nimport * as React from 'react';\nimport { EmotionIconBase } from '@emotion-icons/emotion-icon';\nexport var InsertChart = /*#__PURE__*/React.forwardRef(function (props, ref) {\n  var attrs = {\n    \"fill\": \"currentColor\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\"\n  };\n  return /*#__PURE__*/React.createElement(EmotionIconBase, _extends({\n    iconAttrs: attrs,\n    iconVerticalAlign: \"middle\",\n    iconViewBox: \"0 0 24 24\"\n  }, props, {\n    ref: ref\n  }), /*#__PURE__*/React.createElement(\"path\", {\n    fill: \"none\",\n    d: \"M0 0h24v24H0V0z\"\n  }), /*#__PURE__*/React.createElement(\"path\", {\n    d: \"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z\"\n  }));\n});\nInsertChart.displayName = 'InsertChart';\nexport var InsertChartDimensions = {\n  height: 24,\n  width: 24\n};","import _extends from \"@babel/runtime/helpers/extends\";\nimport * as React from 'react';\nimport { EmotionIconBase } from '@emotion-icons/emotion-icon';\nexport var TableChart = /*#__PURE__*/React.forwardRef(function (props, ref) {\n  var attrs = {\n    \"fill\": \"currentColor\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\"\n  };\n  return /*#__PURE__*/React.createElement(EmotionIconBase, _extends({\n    iconAttrs: attrs,\n    iconVerticalAlign: \"middle\",\n    iconViewBox: \"0 0 24 24\"\n  }, props, {\n    ref: ref\n  }), /*#__PURE__*/React.createElement(\"path\", {\n    fill: \"none\",\n    d: \"M0 0h24v24H0V0z\"\n  }), /*#__PURE__*/React.createElement(\"path\", {\n    d: \"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z\"\n  }));\n});\nTableChart.displayName = 'TableChart';\nexport var TableChartDimensions = {\n  height: 24,\n  width: 24\n};","/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2025)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useMemo } from \"react\"\n\nimport { useEmotionTheme } from \"~lib/hooks/useEmotionTheme\"\nimport { EmotionTheme } from \"~lib/theme\"\nimport { isNullOrUndefined } from \"~lib/util/utils\"\n\nimport { VegaLiteChartElement } from \"./arrowUtils\"\nimport { applyStreamlitTheme, applyThemeDefaults } from \"./CustomTheme\"\n\n/**\n * Fix bug where Vega Lite was vertically-cropping the x-axis in some cases.\n */\nconst BOTTOM_PADDING = 20\n\n/**\n * Prepares the vega-lite spec for selections by transforming the select parameters\n * to a full object specification and by automatically adding encodings (if missing)\n * to point selections.\n *\n * The changes are applied in-place to the spec object.\n *\n * @param spec The Vega-Lite specification of the chart.\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\nexport function prepareSpecForSelections(spec: any): void {\n  if (\"params\" in spec && \"encoding\" in spec) {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n    spec.params.forEach((param: any) => {\n      if (!(\"select\" in param)) {\n        // We are only interested in transforming select parameters.\n        // Other parameters are skipped.\n        return\n      }\n\n      if ([\"interval\", \"point\"].includes(param.select)) {\n        // The select object can be either a single string (short-hand) specifying\n        // \"interval\" or \"point\" or an object that can contain additional\n        // properties as defined here: https://vega.github.io/vega-lite/docs/selection.html\n        // We convert the short-hand notation to the full object specification,\n        // so that we can attach additional properties to this below.\n        param.select = {\n          type: param.select,\n        }\n      }\n\n      if (!(\"type\" in param.select)) {\n        // The type property is required in the spec.\n        // But we check anyways and skip all parameters that don't have it.\n        return\n      }\n\n      if (\n        param.select.type === \"point\" &&\n        !(\"encodings\" in param.select) &&\n        isNullOrUndefined(param.select.encodings)\n      ) {\n        // If encodings are not specified by the user, we add all the encodings from\n        // the chart to the selection parameter. This is required so that points\n        // selections are correctly resolved to a PointSelection and not an IndexSelection:\n        // https://github.com/altair-viz/altair/issues/3285#issuecomment-1858860696\n        param.select.encodings = Object.keys(spec.encoding)\n      }\n    })\n  }\n}\n\nconst generateSpec = (\n  inputSpec: string,\n  useContainerWidth: boolean,\n  useContainerHeight: boolean,\n  vegaLiteTheme: string,\n  selectionMode: string[],\n  theme: EmotionTheme,\n  containerWidth: number,\n  containerHeight?: number\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n): any => {\n  const spec = JSON.parse(inputSpec)\n  if (vegaLiteTheme === \"streamlit\") {\n    spec.config = applyStreamlitTheme(spec.config, theme)\n  } else if (spec.usermeta?.embedOptions?.theme === \"streamlit\") {\n    spec.config = applyStreamlitTheme(spec.config, theme)\n    // Remove the theme from the usermeta so it doesn't get picked up by vega embed.\n    spec.usermeta.embedOptions.theme = undefined\n  } else {\n    // Apply minor theming improvements to work better with Streamlit\n    spec.config = applyThemeDefaults(spec.config, theme)\n  }\n\n  if (spec.title) {\n    if (typeof spec.title === \"string\") {\n      spec.title = { text: spec.title }\n    }\n\n    spec.title.limit =\n      // Preserve existing limit if it exists,\n      spec.title.limit ??\n      // Otherwise, calculate the width - 40px to give some padding, especially\n      // for the ... menu button. If the width is less than 40px, we set it to\n      // 0 to avoid negative values.\n      Math.max(containerWidth - 40, 0)\n  }\n\n  if (useContainerHeight) {\n    spec.height = containerHeight\n  }\n\n  if (useContainerWidth) {\n    spec.width = containerWidth\n\n    if (\"vconcat\" in spec) {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n      spec.vconcat.forEach((child: any) => {\n        child.width = containerWidth\n      })\n    }\n  }\n\n  if (!spec.padding) {\n    spec.padding = {}\n  }\n\n  if (isNullOrUndefined(spec.padding.bottom)) {\n    spec.padding.bottom = BOTTOM_PADDING\n  }\n\n  if (spec.datasets) {\n    throw new Error(\"Datasets should not be passed as part of the spec\")\n  }\n\n  if (selectionMode.length > 0) {\n    prepareSpecForSelections(spec)\n  }\n  return spec\n}\n\n/**\n * Preprocesses the element to generate the VegaLite spec.\n * It stabilizes some of the references (e.g. selectionMode and spec)\n * and avoids further processing if unnecessary.\n */\nexport const useVegaElementPreprocessor = (\n  element: VegaLiteChartElement,\n  containerWidth: number,\n  containerHeight: number,\n  useContainerWidth: boolean,\n  useContainerHeight: boolean\n): VegaLiteChartElement => {\n  const theme = useEmotionTheme()\n\n  const {\n    id,\n    formId,\n    spec: inputSpec,\n    data,\n    datasets,\n    vegaLiteTheme,\n    selectionMode: inputSelectionMode,\n  } = element\n\n  // Selection Mode is an array, so we want to update it only when the contents\n  // change, not the reference itself (since each forward message would be a new\n  // reference).\n  const selectionMode = useMemo(() => {\n    return inputSelectionMode\n    // eslint-disable-next-line react-hooks/react-compiler\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [JSON.stringify(inputSelectionMode)])\n\n  const spec = useMemo(\n    () =>\n      generateSpec(\n        inputSpec,\n        useContainerWidth,\n        useContainerHeight,\n        vegaLiteTheme,\n        selectionMode,\n        theme,\n        containerWidth,\n        containerHeight\n      ),\n    [\n      inputSpec,\n      useContainerWidth,\n      useContainerHeight,\n      vegaLiteTheme,\n      selectionMode,\n      theme,\n      containerWidth,\n      containerHeight,\n    ]\n  )\n\n  return {\n    id,\n    formId,\n    vegaLiteTheme,\n    spec,\n    selectionMode,\n    data,\n    datasets,\n    useContainerWidth,\n  }\n}\n","/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2025)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DataFrameCellType,\n  getTimezone,\n  isDatetimeType,\n  isDateType,\n  isNumericType,\n} from \"~lib/dataframes/arrowTypeUtils\"\nimport { Quiver } from \"~lib/dataframes/Quiver\"\nimport { isNullOrUndefined } from \"~lib/util/utils\"\n\nconst MagicFields = {\n  DATAFRAME_INDEX: \"(index)\",\n}\n\n/** All of the data that makes up a VegaLite chart. */\nexport interface VegaLiteChartElement {\n  /**\n   * The dataframe that will be used as the chart's main data source, if\n   * specified using Vega-Lite's inline API.\n   *\n   * This is mutually exclusive with WrappedNamedDataset - if `data` is non-null,\n   * `datasets` will not be populated; if `datasets` is populated, then `data`\n   * will be null.\n   */\n  data: Quiver | null\n\n  /** The a JSON-formatted string with the Vega-Lite spec. */\n  spec: string\n\n  /**\n   * Dataframes associated with this chart using Vega-Lite's datasets API,\n   * if any.\n   */\n  datasets: WrappedNamedDataset[]\n\n  /** If True, will overwrite the chart width spec to fit to container. */\n  useContainerWidth: boolean\n\n  /** override the properties with a theme. Currently, only \"streamlit\" or None are accepted. */\n  vegaLiteTheme: string\n\n  /** The widget ID. Only set if selections are activated. */\n  id: string\n\n  /** Named selection parameters that are activated to trigger reruns. */\n  selectionMode: string[]\n\n  /** The form ID if the chart has activated selections and is used within a form. */\n  formId: string\n}\n\n/** A mapping of `ArrowNamedDataSet.proto`. */\nexport interface WrappedNamedDataset {\n  /** The dataset's optional name. */\n  name: string | null\n\n  /** True if the name field (above) was manually set. */\n  hasName: boolean\n\n  /** The data itself, wrapped in a Quiver object. */\n  data: Quiver\n}\n\nexport function getInlineData(\n  quiverData: Quiver | null\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n): { [field: string]: any }[] | null {\n  if (!quiverData || quiverData.dimensions.numDataRows === 0) {\n    return null\n  }\n\n  return getDataArray(quiverData)\n}\n\nexport function getDataArrays(\n  datasets: WrappedNamedDataset[]\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n): { [dataset: string]: any[] } | null {\n  const datasetMapping = getDataSets(datasets)\n  if (isNullOrUndefined(datasetMapping)) {\n    return null\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n  const datasetArrays: { [dataset: string]: any[] } = {}\n\n  for (const [name, dataset] of Object.entries(datasetMapping)) {\n    datasetArrays[name] = getDataArray(dataset)\n  }\n\n  return datasetArrays\n}\n\nexport function getDataSets(\n  datasets: WrappedNamedDataset[]\n): { [dataset: string]: Quiver } | null {\n  if (datasets?.length === 0) {\n    return null\n  }\n\n  const datasetMapping: { [dataset: string]: Quiver } = {}\n\n  datasets.forEach((x: WrappedNamedDataset) => {\n    if (!x) {\n      return\n    }\n    const name = x.hasName ? x.name : null\n    datasetMapping[name as string] = x.data\n  })\n\n  return datasetMapping\n}\n\n/**\n * Retrieves an array of data from Quiver starting from a specified index.\n * Converts data values to a format compatible with VegaLite visualization.\n *\n * @param {Quiver} quiverData - The Quiver data object to extract data from.\n * @param {number} [startIndex=0] - The starting index for data extraction.\n * @returns {Array.<{ [field: string]: any }>} An array of data objects for visualization.\n */\nexport function getDataArray(\n  quiverData: Quiver,\n  startIndex = 0\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n): { [field: string]: any }[] {\n  if (quiverData.dimensions.numDataRows === 0) {\n    return []\n  }\n\n  const dataArr = []\n  const { numDataRows, numDataColumns, numIndexColumns } =\n    quiverData.dimensions\n\n  // This currently only implemented to work with a single index column.\n  // If the dataframe is multi-index, the remaining index columns will be ignored.\n  const firstIndexColumnType = quiverData.columnTypes[0] ?? undefined\n  const hasSupportedIndex =\n    firstIndexColumnType &&\n    firstIndexColumnType.type === DataFrameCellType.INDEX &&\n    (isNumericType(firstIndexColumnType) ||\n      isDatetimeType(firstIndexColumnType) ||\n      isDateType(firstIndexColumnType))\n\n  for (let rowIndex = startIndex; rowIndex < numDataRows; rowIndex++) {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n    const row: { [field: string]: any } = {}\n\n    if (hasSupportedIndex) {\n      const { content: indexValue } = quiverData.getCell(rowIndex, 0)\n      // VegaLite can't handle BigInts, so they have to be converted to Numbers first\n      // Converting to numbers here might loses accuracy for numbers larger than the max safe integer.\n      row[MagicFields.DATAFRAME_INDEX] =\n        typeof indexValue === \"bigint\" ? Number(indexValue) : indexValue\n    }\n\n    for (let colIndex = 0; colIndex < numDataColumns; colIndex++) {\n      // The underlying dataframe expects the column position to start at 0 with\n      // the index columns first. Therefore, we need to adjust the position\n      // to account for the index columns.\n      const colPos = colIndex + numIndexColumns\n      const { content: dataValue, contentType: dataType } = quiverData.getCell(\n        rowIndex,\n        colPos\n      )\n\n      if (\n        (dataValue instanceof Date ||\n          (typeof dataValue === \"number\" && Number.isFinite(dataValue))) &&\n        (isDatetimeType(dataType) || isDateType(dataType)) &&\n        // Only convert dates without timezone information\n        // to utc timezone\n        !getTimezone(dataType)\n      ) {\n        // For dates that do not contain timezone information.\n        // Vega JS assumes dates in the local timezone, so we need to convert\n        // UTC date to be the same date in the local timezone.\n        const offset = new Date(dataValue).getTimezoneOffset() * 60 * 1000 // minutes to milliseconds\n        row[quiverData.columnNames[0][colPos]] = dataValue.valueOf() + offset\n      } else {\n        // VegaLite can't handle BigInts, so they have to be converted to Numbers first.\n        // Converting to numbers here might loses accuracy for numbers larger than the max safe integer.\n        row[quiverData.columnNames[0][colPos]] =\n          typeof dataValue === \"bigint\" ? Number(dataValue) : dataValue\n      }\n    }\n    dataArr.push(row)\n  }\n\n  return dataArr\n}\n","/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2025)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useCallback } from \"react\"\n\nimport isEqual from \"lodash/isEqual\"\nimport { getLogger } from \"loglevel\"\nimport { SignalValue, View as VegaView } from \"vega\"\n\nimport { debounce, notNullOrUndefined } from \"~lib/util/utils\"\nimport { WidgetInfo, WidgetStateManager } from \"~lib/WidgetStateManager\"\n\nimport { VegaLiteChartElement } from \"./arrowUtils\"\n\n/**\n * Debounce time for triggering a widget state update\n * This prevents to rapid updates to the widget state.\n */\nconst DEBOUNCE_TIME_MS = 150\n\n/** This is the state that is sent to the backend\n * This needs to be the same structure that is also defined\n * in the Python code.\n */\nexport interface VegaLiteState {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n  selection: Record<string, any>\n}\n\nexport interface UseVegaLiteSelectionsOutput {\n  maybeConfigureSelections: (view: VegaView) => VegaView\n  onFormCleared: () => void\n}\n\nconst LOG = getLogger(\"useVegaLiteSelections\")\n\n/**\n * Hook that returns a function that can be used to configure the selection\n * events for a vega-lite chart.\n *\n * @param element The vega-lite chart element\n * @param widgetMgr The widget manager\n * @param fragmentId The fragment id of the element\n */\nexport const useVegaLiteSelections = (\n  element: VegaLiteChartElement,\n  widgetMgr: WidgetStateManager,\n  fragmentId?: string\n): UseVegaLiteSelectionsOutput => {\n  const { id: chartId, formId, selectionMode } = element\n\n  const maybeConfigureSelections = useCallback(\n    (vegaView: VegaView): VegaView => {\n      // Add listeners for all selection events. Find out more here:\n      // https://vega.github.io/vega/docs/api/view/#view_addSignalListener\n      selectionMode.forEach(param => {\n        vegaView.addSignalListener(\n          param,\n          debounce(DEBOUNCE_TIME_MS, (name: string, value: SignalValue) => {\n            // Store the current chart selection state with the widget manager so that it\n            // can be used for restoring the state when the component unmounted and\n            // created again. This can happen when elements are added before it within\n            // the delta path. The viewState is only stored in the frontend, and not\n            // synced to the backend.\n            const viewState = vegaView.getState({\n              // There are also `signals` data, but I believe its\n              // not relevant for restoring the selection state.\n              data: (nameArg?: string, _operator?: unknown) => {\n                // Vega lite stores the selection state in a <param name>_store parameter\n                // under `data` that can be retrieved via the getState method.\n                // https://vega.github.io/vega/docs/api/view/#view_getState\n                return selectionMode.some(mode => `${mode}_store` === nameArg)\n              },\n              // Don't include subcontext data since it will lead to exceptions\n              // when loading the state.\n              recurse: false,\n            })\n\n            if (notNullOrUndefined(viewState)) {\n              widgetMgr.setElementState(chartId, \"viewState\", viewState)\n            }\n\n            // If selection encodings are correctly specified, vega-lite will return\n            // a list of selected points within the vlPoint.or property:\n            // https://github.com/vega/altair/blob/f1b4e2c84da2fba220022c8a285cc8280f824ed8/altair/utils/selection.py#L50\n            // We want to just return this list of points instead of the entire object\n            // since the other parts of the selection object are not useful.\n            let processedSelection = value\n            if (\"vlPoint\" in value && \"or\" in value.vlPoint) {\n              processedSelection = value.vlPoint.or\n            }\n\n            const widgetInfo: WidgetInfo = { id: chartId, formId }\n\n            // Get the current widget state\n            const currentWidgetState = JSON.parse(\n              widgetMgr.getStringValue(widgetInfo) || \"{}\"\n            )\n\n            // Update the component-internal selection state\n            const updatedSelections = {\n              selection: {\n                ...(currentWidgetState?.selection || {}),\n                [name]: processedSelection || {},\n              } as VegaLiteState,\n            }\n\n            // Update the widget state if the selection state has changed\n            // compared to the last update. This selection state will be synced\n            // with the backend.\n            if (!isEqual(currentWidgetState, updatedSelections)) {\n              widgetMgr.setStringValue(\n                widgetInfo,\n                JSON.stringify(updatedSelections),\n                {\n                  fromUi: true,\n                },\n                fragmentId\n              )\n            }\n          })\n        )\n      })\n\n      // Try to load the previous state of the chart from the element state.\n      // This is useful to restore the selection state when the component is re-mounted\n      // or when its put into fullscreen mode.\n      const viewState = widgetMgr.getElementState(chartId, \"viewState\")\n      if (notNullOrUndefined(viewState)) {\n        try {\n          return vegaView.setState(viewState)\n        } catch (e) {\n          LOG.warn(\"Failed to restore view state\", e)\n        }\n      }\n\n      return vegaView\n    },\n    [chartId, selectionMode, widgetMgr, formId, fragmentId]\n  )\n\n  const onFormCleared = useCallback(() => {\n    const emptySelectionState: VegaLiteState = {\n      selection: {},\n    }\n    // Initialize all parameters defined in the selectionMode with an empty object.\n    selectionMode.forEach(param => {\n      emptySelectionState.selection[param] = {}\n    })\n    const widgetInfo = { id: chartId, formId }\n    const currentWidgetStateStr = widgetMgr.getStringValue(widgetInfo)\n    const currentWidgetState = currentWidgetStateStr\n      ? JSON.parse(currentWidgetStateStr)\n      : // If there wasn't any selection yet, the selection state\n        // is assumed to be empty.\n        emptySelectionState\n\n    if (!isEqual(currentWidgetState, emptySelectionState)) {\n      widgetMgr.setStringValue(\n        widgetInfo,\n        JSON.stringify(emptySelectionState),\n        {\n          fromUi: true,\n        },\n        fragmentId\n      )\n    }\n  }, [chartId, formId, fragmentId, selectionMode, widgetMgr])\n\n  return { maybeConfigureSelections, onFormCleared }\n}\n","/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2025)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { RefObject, useCallback, useEffect, useRef } from \"react\"\n\nimport { getLogger } from \"loglevel\"\nimport { truthy, View as VegaView } from \"vega\"\nimport embed from \"vega-embed\"\nimport { expressionInterpreter } from \"vega-interpreter\"\n\nimport { useFormClearHelper } from \"~lib/components/widgets/Form\"\nimport { Quiver } from \"~lib/dataframes/Quiver\"\nimport { WidgetStateManager } from \"~lib/WidgetStateManager\"\n\nimport {\n  getDataArray,\n  getDataArrays,\n  getDataSets,\n  getInlineData,\n  VegaLiteChartElement,\n  WrappedNamedDataset,\n} from \"./arrowUtils\"\nimport { useVegaLiteSelections } from \"./useVegaLiteSelections\"\n\nconst DEFAULT_DATA_NAME = \"source\"\nconst LOG = getLogger(\"useVegaEmbed\")\n\ninterface UseVegaEmbedOutput {\n  createView: (\n    containerRef: RefObject<HTMLDivElement>,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n    spec: any\n  ) => Promise<VegaView | null>\n  updateView: (\n    data: Quiver | null,\n    datasets: WrappedNamedDataset[]\n  ) => Promise<VegaView | null>\n  finalizeView: () => void\n}\n\n/**\n * Hook that returns a set of lifecycle functions that can be used to create,\n * update, and remove a vega-lite chart into the DOM.\n *\n * @param inputElement The vega-lite chart element\n * @param widgetMgr The widget manager\n * @param fragmentId The fragment id of the element\n */\nexport function useVegaEmbed(\n  inputElement: VegaLiteChartElement,\n  widgetMgr: WidgetStateManager,\n  fragmentId?: string\n): UseVegaEmbedOutput {\n  const vegaView = useRef<VegaView | null>(null)\n  const vegaFinalizer = useRef<(() => void) | null>(null)\n  const defaultDataName = useRef<string>(DEFAULT_DATA_NAME)\n  const dataRef = useRef<Quiver | null>(null)\n  const datasetsRef = useRef<WrappedNamedDataset[]>([])\n\n  // Setup interactivity for the chart if it supports selections\n  const { maybeConfigureSelections, onFormCleared } = useVegaLiteSelections(\n    inputElement,\n    widgetMgr,\n    fragmentId\n  )\n\n  useFormClearHelper({ widgetMgr, element: inputElement, onFormCleared })\n\n  const { data, datasets } = inputElement\n\n  // Initialize the data and datasets refs with the current data and datasets\n  // This is predominantly used to handle the case where we want to reference\n  // these in createView before the first render.\n  useEffect(() => {\n    if (vegaView.current === null) {\n      dataRef.current = data\n      datasetsRef.current = datasets\n    }\n  }, [data, datasets])\n\n  const finalizeView = useCallback(() => {\n    if (vegaFinalizer.current) {\n      vegaFinalizer.current()\n    }\n\n    vegaFinalizer.current = null\n    vegaView.current = null\n  }, [])\n\n  const createView = useCallback(\n    async (\n      containerRef: RefObject<HTMLDivElement>,\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any -- TODO: Replace 'any' with a more specific type.\n      spec: any\n    ): Promise<VegaView | null> => {\n      if (containerRef.current === null) {\n        throw new Error(\"Element missing.\")\n      }\n\n      // Finalize the previous view so it can be garbage collected.\n      finalizeView()\n\n      const options = {\n        // Adds interpreter support for Vega expressions that is compliant with CSP\n        ast: true,\n        expr: expressionInterpreter,\n\n        // Disable default styles so that vega doesn't inject <style> tags in the\n        // DOM. We set these styles manually for finer control over them and to\n        // avoid inlining styles.\n        tooltip: { disableDefaultStyle: true },\n        defaultStyle: false,\n        forceActionsMenu: true,\n      }\n\n      const { vgSpec, view, finalize } = await embed(\n        containerRef.current,\n        spec,\n        options\n      )\n\n      vegaView.current = maybeConfigureSelections(view)\n\n      vegaFinalizer.current = finalize\n\n      // Load the initial set of data into the chart.\n      const dataArrays = getDataArrays(datasetsRef.current)\n\n      // Heuristic to determine the default dataset name.\n      const datasetNames = dataArrays ? Object.keys(dataArrays) : []\n      if (datasetNames.length === 1) {\n        const [datasetName] = datasetNames\n        defaultDataName.current = datasetName\n      } else if (datasetNames.length === 0 && vgSpec.data) {\n        defaultDataName.current = DEFAULT_DATA_NAME\n      }\n\n      const dataObj = getInlineData(dataRef.current)\n      if (dataObj) {\n        vegaView.current.insert(defaultDataName.current, dataObj)\n      }\n      if (dataArrays) {\n        for (const [name, dataArg] of Object.entries(dataArrays)) {\n          vegaView.current.insert(name, dataArg)\n        }\n      }\n\n      await vegaView.current.runAsync()\n\n      // Fix bug where the \"...\" menu button overlaps with charts where width is\n      // set to -1 on first load.\n      await vegaView.current.resize().runAsync()\n\n      return vegaView.current\n    },\n    [finalizeView, maybeConfigureSelections]\n  )\n\n  const updateData = useCallback(\n    (\n      view: VegaView,\n      name: string,\n      prevData: Quiver | null,\n      dataArg: Quiver | null\n    ): void => {\n      if (!dataArg || dataArg.dimensions.numDataRows === 0) {\n        // The new data is empty, so we remove the dataset from the\n        // chart view if the named dataset exists.\n        try {\n          view.remove(name, truthy)\n        } finally {\n          // The finally block ensures execution flow continues even if view.remove() fails\n          // This allows us to safely exit the function while still propagating any errors\n        }\n        return\n      }\n\n      if (!prevData || prevData.dimensions.numDataRows === 0) {\n        // The previous data was empty, so we just insert the new data.\n        view.insert(name, getDataArray(dataArg))\n        return\n      }\n\n      // Check if dataframes have same \"shape\" but the new one has more rows.\n      if (dataArg.hash !== prevData.hash) {\n        // Clean the dataset and insert from scratch.\n        view.data(name, getDataArray(dataArg))\n        LOG.info(\n          `Had to clear the ${name} dataset before inserting data through Vega view.`\n        )\n      }\n    },\n    []\n  )\n\n  const updateView = useCallback(\n    async (\n      inputData: Quiver | null,\n      inputDatasets: WrappedNamedDataset[]\n    ): Promise<VegaView | null> => {\n      if (vegaView.current === null) {\n        return null\n      }\n\n      // At this point the previous data should be updated\n      const prevData = dataRef.current\n      const prevDatasets = datasetsRef.current\n\n      if (prevData || inputData) {\n        updateData(\n          vegaView.current,\n          defaultDataName.current,\n          prevData,\n          inputData\n        )\n      }\n\n      const prevDataSets = getDataSets(prevDatasets) ?? {}\n      const dataSets = getDataSets(inputDatasets) ?? {}\n\n      for (const [name, dataset] of Object.entries(dataSets)) {\n        const datasetName = name || defaultDataName.current\n        const prevDataset = prevDataSets[datasetName]\n\n        updateData(vegaView.current, datasetName, prevDataset, dataset)\n      }\n\n      // Remove all datasets that are in the previous but not the current datasets.\n      for (const name of Object.keys(prevDataSets)) {\n        if (\n          !Object.hasOwn(dataSets, name) &&\n          name !== defaultDataName.current\n        ) {\n          updateData(vegaView.current, name, null, null)\n        }\n      }\n\n      await vegaView.current?.resize().runAsync()\n\n      dataRef.current = inputData\n      datasetsRef.current = inputDatasets\n\n      return vegaView.current\n    },\n    [updateData]\n  )\n\n  return { createView, updateView, finalizeView }\n}\n","/**\n * Copyright (c) Streamlit Inc. (2018-2022) Snowflake Inc. (2022-2025)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { FC, memo, useEffect, useLayoutEffect, useState } from \"react\"\n\nimport { Global } from \"@emotion/react\"\nimport { InsertChart, TableChart } from \"@emotion-icons/material-outlined\"\n\nimport { streamlit } from \"@streamlit/protobuf\"\n\nimport {\n  shouldHeightStretch,\n  shouldWidthStretch,\n} from \"~lib/components/core/Layout/utils\"\nimport { ElementFullscreenContext } from \"~lib/components/shared/ElementFullscreen/ElementFullscreenContext\"\nimport { withFullScreenWrapper } from \"~lib/components/shared/FullScreenWrapper\"\nimport Toolbar, {\n  StyledToolbarElementContainer,\n  ToolbarAction,\n} from \"~lib/components/shared/Toolbar\"\nimport { ReadOnlyGrid } from \"~lib/components/widgets/DataFrame\"\nimport { useCalculatedDimensions } from \"~lib/hooks/useCalculatedDimensions\"\nimport { useRequiredContext } from \"~lib/hooks/useRequiredContext\"\nimport { WidgetStateManager } from \"~lib/WidgetStateManager\"\n\nimport { VegaLiteChartElement } from \"./arrowUtils\"\nimport {\n  StyledVegaLiteChartContainer,\n  StyledVegaLiteChartTooltips,\n} from \"./styled-components\"\nimport { useVegaElementPreprocessor } from \"./useVegaElementPreprocessor\"\nimport { useVegaEmbed } from \"./useVegaEmbed\"\n\nfunction isFacetChart(spec: string | object): boolean {\n  try {\n    const parsedSpec = typeof spec === \"string\" ? JSON.parse(spec) : spec\n\n    return !!(\n      parsedSpec.facet ||\n      // TODO (lawilby): do some tests for row/column\n      // shorthand facet charts to confirm they work with\n      // sizing in the same way.\n      parsedSpec.encoding?.row ||\n      parsedSpec.encoding?.column ||\n      parsedSpec.encoding?.facet\n    )\n  } catch {\n    return false\n  }\n}\nexport interface Props {\n  element: VegaLiteChartElement\n  widgetMgr: WidgetStateManager\n  fragmentId?: string\n  disableFullscreenMode?: boolean\n  widthConfig: streamlit.IWidthConfig | null | undefined\n  heightConfig: streamlit.IHeightConfig | null | undefined\n}\n\nconst ArrowVegaLiteChart: FC<Props> = ({\n  disableFullscreenMode,\n  element: inputElement,\n  fragmentId,\n  widgetMgr,\n  widthConfig,\n  heightConfig,\n}) => {\n  const [showData, setShowData] = useState(false)\n  const [enableShowData, setEnableShowData] = useState(false)\n\n  const {\n    expanded: isFullScreen,\n    height: fullScreenHeight,\n    width: fullScreenWidth,\n    expand,\n    collapse,\n  } = useRequiredContext(ElementFullscreenContext)\n\n  // When we are in full screen mode, this will be the\n  // width/height of the screen based on the expansion\n  // of the parent StyledFullScreenFrame.\n  // Otherwise, it will be according to the user's settings\n  // determined by styling on the StyledElementContainer.\n  const {\n    width: chartContainerWidth,\n    height: chartContainerHeight,\n    elementRef: containerRef,\n  } = useCalculatedDimensions(\n    // We need to update whenever the showData state changes because\n    // the underlying element ref that needs to be observed is updated.\n    [showData],\n    // Use 0 as fallback instead of -1 because Vega-Lite cannot handle negative dimensions\n    0\n  )\n\n  const useStretchWidth =\n    shouldWidthStretch(widthConfig) || inputElement.useContainerWidth\n\n  const useStretchHeight = shouldHeightStretch(heightConfig)\n\n  // Facet charts need the container element to have a width and also\n  // do not work well with stretch/container width\n  // so they cannot use the width from the StyledVegaLiteChartContainer.\n  const isFacet = isFacetChart(inputElement.spec)\n\n  // We preprocess the input vega element to do a two things:\n  // 1. Update the spec to handle Streamlit specific configurations such as\n  //    theming, container width, and full screen mode\n  // 2. Stabilize some aspects of the input element to detect changes in the\n  //    configuration of the chart since each element will always provide new references\n  //    Note: We do not stabilize data/datasets as that is managed by the embed.\n  const element = useVegaElementPreprocessor(\n    inputElement,\n    // Facet charts enter a loop when using the width/height from the StyledVegaLiteChartContainer.\n    isFacet ? (fullScreenWidth ?? 0) : chartContainerWidth,\n    (isFullScreen ? fullScreenHeight : chartContainerHeight) ?? 0,\n    isFullScreen ? true : useStretchWidth,\n    isFullScreen ? true : useStretchHeight\n  )\n\n  // This hook provides lifecycle functions for creating and removing the view.\n  // It also will update the view if the data changes (and not the spec)\n  const { createView, updateView, finalizeView } = useVegaEmbed(\n    element,\n    widgetMgr,\n    fragmentId\n  )\n\n  const { data, datasets, spec } = element\n\n  // Create the view once the container is ready and re-create\n  // if the spec changes or the dimensions change.\n  // We utilize useLayoutEffect to ensure that the view is created\n  // after the container is mounted to avoid layout shift.\n  useLayoutEffect(() => {\n    // TODO(lawilby): Can we just update the view if the width/height changes?\n    if (containerRef.current !== null) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises -- TODO: Fix this\n      createView(containerRef, spec)\n    }\n\n    return finalizeView\n    // We can't use chartContainerWidth/containerHeight in this dependency array because it causes facet charts to enter a loop.\n    // TODO(lawilby): Do we need width/height in this dependency array? It seems any changes\n    // Are the changes in the spec enough?\n  }, [\n    createView,\n    finalizeView,\n    spec,\n    fullScreenWidth,\n    fullScreenHeight,\n    showData,\n    containerRef,\n  ])\n\n  // The references to data and datasets will always change each rerun\n  // because the forward message always produces new references, so\n  // this function will run regularly to update the view.\n  useEffect(() => {\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises -- TODO: Fix this\n    updateView(data, datasets)\n  }, [data, datasets, updateView])\n\n  useEffect(() => {\n    // We only show data if its provided via data or if there\n    // is one data set in the datasets array. In this case,\n    // only the first dataset is shown:\n    if (data || datasets?.[0]?.data) {\n      setEnableShowData(true)\n    } else {\n      setEnableShowData(false)\n    }\n  }, [data, datasets])\n\n  if (showData) {\n    return (\n      <ReadOnlyGrid\n        data={data ?? datasets[0]?.data}\n        height={fullScreenHeight ?? chartContainerHeight ?? undefined}\n        customToolbarActions={[\n          <ToolbarAction\n            key=\"show-chart\"\n            label=\"Show chart\"\n            icon={InsertChart}\n            onClick={() => {\n              setShowData(false)\n            }}\n          />,\n        ]}\n      />\n    )\n  }\n\n  // Create the container inside which Vega draws its content.\n  // To style the Vega tooltip, we need to apply global styles since\n  // the tooltip element is drawn outside of this component.\n  return (\n    <StyledToolbarElementContainer\n      height={\n        useStretchHeight\n          ? isFullScreen\n            ? fullScreenHeight\n            : \"100%\"\n          : fullScreenHeight\n      }\n      useContainerWidth={isFullScreen ? true : useStretchWidth}\n    >\n      <Toolbar\n        target={StyledToolbarElementContainer}\n        isFullScreen={isFullScreen}\n        onExpand={expand}\n        onCollapse={collapse}\n        disableFullscreenMode={disableFullscreenMode}\n      >\n        {enableShowData && (\n          <ToolbarAction\n            label=\"Show data\"\n            icon={TableChart}\n            onClick={() => {\n              setShowData(true)\n            }}\n          />\n        )}\n      </Toolbar>\n      <Global styles={StyledVegaLiteChartTooltips} />\n      <StyledVegaLiteChartContainer\n        data-testid=\"stVegaLiteChart\"\n        className=\"stVegaLiteChart\"\n        useContainerWidth={useStretchWidth}\n        useContainerHeight={useStretchHeight}\n        ref={containerRef}\n      />\n    </StyledToolbarElementContainer>\n  )\n}\n\nconst ArrowVegaLiteChartWithFullScreen =\n  withFullScreenWrapper(ArrowVegaLiteChart)\nexport default memo(ArrowVegaLiteChartWithFullScreen)\n"],"names":["InsertChart","React.forwardRef","props","ref","attrs","React.createElement","EmotionIconBase","_extends","TableChart","BOTTOM_PADDING","prepareSpecForSelections","spec","params","forEach","param","includes","select","type","isNullOrUndefined","encodings","Object","keys","encoding","generateSpec","inputSpec","useContainerWidth","useContainerHeight","vegaLiteTheme","selectionMode","theme","containerWidth","containerHeight","JSON","parse","config","applyStreamlitTheme","usermeta","embedOptions","undefined","applyThemeDefaults","title","text","limit","Math","max","height","width","vconcat","child","padding","bottom","datasets","Error","length","useVegaElementPreprocessor","element","useEmotionTheme","id","formId","data","inputSelectionMode","useMemo","stringify","MagicFields","DATAFRAME_INDEX","getInlineData","quiverData","dimensions","numDataRows","getDataArray","getDataArrays","datasetMapping","getDataSets","datasetArrays","name","dataset","entries","x","hasName","startIndex","dataArr","numDataColumns","numIndexColumns","firstIndexColumnType","columnTypes","hasSupportedIndex","DataFrameCellType","INDEX","isNumericType","isDatetimeType","isDateType","rowIndex","row","content","indexValue","getCell","Number","colIndex","colPos","dataValue","contentType","dataType","Date","isFinite","getTimezone","offset","getTimezoneOffset","columnNames","valueOf","push","DEBOUNCE_TIME_MS","LOG","getLogger","useVegaLiteSelections","widgetMgr","fragmentId","chartId","maybeConfigureSelections","useCallback","vegaView","addSignalListener","debounce","value","viewState","getState","nameArg","_operator","some","mode","recurse","notNullOrUndefined","setElementState","processedSelection","vlPoint","or","widgetInfo","currentWidgetState","getStringValue","updatedSelections","selection","isEqual","setStringValue","fromUi","getElementState","setState","e","warn","onFormCleared","emptySelectionState","currentWidgetStateStr","DEFAULT_DATA_NAME","useVegaEmbed","inputElement","useRef","vegaFinalizer","defaultDataName","dataRef","datasetsRef","useFormClearHelper","useEffect","current","finalizeView","createView","containerRef","options","ast","expr","expressionInterpreter","tooltip","disableDefaultStyle","defaultStyle","forceActionsMenu","vgSpec","view","finalize","embed","dataArrays","datasetNames","datasetName","dataObj","insert","dataArg","runAsync","resize","updateData","prevData","remove","truthy","hash","info","updateView","inputData","inputDatasets","prevDatasets","prevDataSets","dataSets","prevDataset","hasOwn","isFacetChart","parsedSpec","facet","column","ArrowVegaLiteChart","disableFullscreenMode","widthConfig","heightConfig","showData","setShowData","useState","enableShowData","setEnableShowData","expanded","isFullScreen","fullScreenHeight","fullScreenWidth","expand","collapse","useRequiredContext","ElementFullscreenContext","chartContainerWidth","chartContainerHeight","elementRef","useCalculatedDimensions","useStretchWidth","shouldWidthStretch","useStretchHeight","shouldHeightStretch","isFacet","useLayoutEffect","jsx","ReadOnlyGrid","ToolbarAction","jsxs","StyledToolbarElementContainer","Toolbar","Global","StyledVegaLiteChartTooltips","StyledVegaLiteChartContainer","ArrowVegaLiteChartWithFullScreen","withFullScreenWrapper","ArrowVegaLiteChart_default","memo"],"mappings":"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","x_google_ignoreList":[0,1]}
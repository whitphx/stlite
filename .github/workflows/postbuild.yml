name: Post-build
run-name: Post-build for ${{ github.event.workflow_run.display_title || github.event.workflow_run.run_number }}

on:
  # For security reasons, this workflow is separated from the test-and-build workflow and triggered by the `workflow_run` event following it.
  # The deployment jobs need access to the repository secrets,
  # however, workflows triggered by the `pull_request` event don't have access to the secrets for security reasons
  # because those workflows check out the PR's branch that may have malicious external contributors' changes,
  # so we can't use the `pull_request` event to trigger the deployment jobs.
  # Then, we have to run the deployment jobs in this separated workflow that is allowed to access the secrets because it runs in the context of the default branch which can be considered as a trusted branch.
  # It is a security good practice introduced in the GitHub's official blog, https://securitylab.github.com/resources/github-actions-preventing-pwn-requests/
  workflow_run:
    workflows: ["Test and Build"]
    types:
      - completed

env:
  python-version-file: ".python-version"
  node-version-file: ".nvmrc"

permissions: {}

jobs:
  get-build-info:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      branch: ${{ steps.build-info.outputs.branch }}
      trigger-sha: ${{ steps.build-info.outputs.trigger-sha }}
      head-sha: ${{ steps.build-info.outputs.head-sha }}
      pr-number: ${{ steps.build-info.outputs.pr-number }}
    steps:
      - name: Download build info
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      - name: Read build info
        id: build-info
        run: |
          echo "branch=$(cat branch)"
          echo "branch=$(cat branch)" >> $GITHUB_OUTPUT
          echo "trigger-sha=$(cat trigger-sha)"
          echo "trigger-sha=$(cat trigger-sha)" >> $GITHUB_OUTPUT
          echo "head-sha=$(cat head-sha)"
          echo "head-sha=$(cat head-sha)" >> $GITHUB_OUTPUT
          echo "pr-number=$(cat pr-number)"
          echo "pr-number=$(cat pr-number)" >> $GITHUB_OUTPUT

  get-changesets-publish-targets:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      browser: ${{ steps.parse-packages.outputs.browser }}
      react: ${{ steps.parse-packages.outputs.react }}
      desktop: ${{ steps.parse-packages.outputs.desktop }}
    steps:
      - name: Download published packages info
        id: download-changesets-published-packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: changesets-published-packages
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true
      - name: Parse published packages
        if: steps.download-changesets-published-packages.outcome == 'success'
        id: parse-packages
        run: |
          PACKAGES=$(cat changesets-published-packages)
          if [ -z "$PACKAGES" ] || [ "$PACKAGES" = "[]" ]; then
            echo "browser=" >> $GITHUB_OUTPUT
            echo "react=" >> $GITHUB_OUTPUT
            echo "desktop=" >> $GITHUB_OUTPUT
          else
            BROWSER_VERSION=$(echo "$PACKAGES" | jq -r '.[] | select(.name == "@stlite/browser") | .version // ""')
            REACT_VERSION=$(echo "$PACKAGES" | jq -r '.[] | select(.name == "@stlite/react") | .version // ""')
            DESKTOP_VERSION=$(echo "$PACKAGES" | jq -r '.[] | select(.name == "@stlite/desktop") | .version // ""')

            echo "browser=$BROWSER_VERSION" >> $GITHUB_OUTPUT
            echo "react=$REACT_VERSION" >> $GITHUB_OUTPUT
            echo "desktop=$DESKTOP_VERSION" >> $GITHUB_OUTPUT
          fi

  inform-package-stats:
    needs: get-build-info
    if: ${{ needs.get-build-info.outputs.pr-number }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: ./.github/actions/inform-package-stats
      with:
        pr-number: ${{ needs.get-build-info.outputs.pr-number }}

  inform-visualizer:
    needs: get-build-info
    if: ${{ needs.get-build-info.outputs.pr-number }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post bundle visualizer links
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ needs.get-build-info.outputs.pr-number }}
          HEAD_SHA: ${{ needs.get-build-info.outputs.head-sha }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        with:
          script: |
            const runId = process.env.WORKFLOW_RUN_ID;
            const headSha =
              process.env.HEAD_SHA || context.payload.workflow_run?.head_sha;

            if (!headSha) {
              core.setFailed("Head SHA is not available.");
              return;
            }
            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId,
              }
            );

            const visualizers = artifacts.filter((artifact) =>
              artifact.name.startsWith("visualizer-")
            );

            if (visualizers.length === 0) {
              core.info("No visualizer artifacts found for this run.");
              return;
            }

            const labels = {
              "visualizer-browser": "@stlite/browser",
              "visualizer-react": "@stlite/react",
              "visualizer-sharing": "@stlite/sharing",
              "visualizer-sharing-editor": "@stlite/sharing-editor",
              "visualizer-desktop": "@stlite/desktop",
            };

            const artifactLines = visualizers
              .map((artifact) => {
                const label =
                  labels[artifact.name] ??
                  artifact.name.replace(/^visualizer-/, "");
                const url = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
                return `- **${label}**: [Bundle report](${url})`;
              })
              .join("\n");

            const stickyHeader = `<!-- Visualizer Report ${headSha} -->\n`;
            const commentBody = `${stickyHeader}## Bundle visualizer reports for \`${headSha.slice(0, 7)}\`\n\n${artifactLines}\n\nDownload the artifact and open the contained HTML locally to inspect the bundle makeup.`;

            const existingComments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(process.env.PR_NUMBER),
              }
            );

            const existingComment = existingComments.find(
              (comment) =>
                comment.body.startsWith(stickyHeader) &&
                comment.user?.login === "github-actions[bot]"
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
              core.info(
                `Updated visualizer report comment on PR #${process.env.PR_NUMBER}`
              );
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(process.env.PR_NUMBER),
                body: commentBody,
              });
              core.info(
                `Created visualizer report comment on PR #${process.env.PR_NUMBER}`
              );
            }
  e2e-browser:
    needs: get-build-info

    permissions:
      contents: read
      statuses: write

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false

    - name: Enable Corepack
      run: corepack enable
    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version-file: ${{ env.node-version-file }}

    - name: Set up the e2e-tests environment
      run: |
        yarn install
        yarn install:browsers
      working-directory: packages/browser/e2e-tests

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-browser
        path: ${{ runner.temp }}/artifacts/browser
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - run: tar xzvf package.tgz
      working-directory: ${{ runner.temp }}/artifacts/browser

    - name: Run the e2e-tests
      run: yarn test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
      working-directory: packages/browser/e2e-tests
      env:
        BUILD_DIR: ${{ runner.temp }}/artifacts/browser/package/build

    - name: Update commit status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATE="success"
        else
          STATE="failure"
        fi
        gh api repos/${{ github.repository }}/statuses/${HEAD_SHA} \
          -X POST \
          -f state=${STATE} \
          -f context=${{ github.job }} \
          -f target_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HEAD_SHA: ${{ needs.get-build-info.outputs.head-sha }}

    - name: Upload blob report to GitHub Actions Artifacts
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: blob-report-${{ matrix.shardIndex }}
        path: packages/browser/e2e-tests/blob-report
        retention-days: 1

  merge-e2e-browser-reports:
    # Merge Playwright reports, even if some shards have failed
    if: ${{ !cancelled() }}
    needs: [e2e-browser]

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
    - name: Enable Corepack
      run: corepack enable
    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version-file: ${{ env.node-version-file }}
    - name: Install dependencies
      run: yarn install
      working-directory: packages/browser/e2e-tests

    - name: Download blob reports from GitHub Actions Artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        path: packages/browser/e2e-tests/all-blob-reports
        pattern: blob-report-*
        merge-multiple: true

    - name: Merge into HTML Report
      run: yarn playwright merge-reports --reporter html ./all-blob-reports
      working-directory: packages/browser/e2e-tests

    - name: Upload HTML report
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: html-report--attempt-${{ github.run_attempt }}
        path: packages/browser/e2e-tests/playwright-report
        retention-days: 14

  e2e-browser-browserstack:
    needs: get-build-info

    permissions:
      contents: read
      statuses: write

    runs-on: ubuntu-latest

    steps:
    - name: 'BrowserStack Env Setup'
      uses: browserstack/github-actions/setup-env@93aebce225b754566349151c0676b26b005e591b # v1.0.4
      with:
        username:  ${{ secrets.BROWSERSTACK_USERNAME }}
        access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

    - name: 'BrowserStack Local Tunnel Setup'
      uses: browserstack/github-actions/setup-local@93aebce225b754566349151c0676b26b005e591b # v1.0.4
      with:
        local-testing: start
        local-identifier: random

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false

    - name: Enable Corepack
      run: corepack enable
    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version-file: ${{ env.node-version-file }}

    - name: Set up the e2e-tests environment
      run: yarn install
      working-directory: packages/browser/e2e-tests

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-browser
        path: ${{ runner.temp }}/artifacts/browser
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - run: tar xzvf package.tgz
      working-directory: ${{ runner.temp }}/artifacts/browser

    - name: Run the e2e-tests
      run: yarn test:browserstack
      working-directory: packages/browser/e2e-tests
      env:
        BUILD_DIR: ${{ runner.temp }}/artifacts/browser/package/build

    - name: 'BrowserStackLocal Stop'
      uses: browserstack/github-actions/setup-local@93aebce225b754566349151c0676b26b005e591b # v1.0.4
      with:
        local-testing: stop

    - name: Update commit status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATE="success"
        else
          STATE="failure"
        fi
        gh api repos/${{ github.repository }}/statuses/${HEAD_SHA} \
          -X POST \
          -f state=${STATE} \
          -f context=${{ github.job }} \
          -f target_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HEAD_SHA: ${{ needs.get-build-info.outputs.head-sha }}

  e2e-desktop:
    needs: get-build-info

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    permissions:
      contents: read
      statuses: write

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false

    - uses: ./.github/actions/init-all
      with:
        node-version-file: ${{ env.node-version-file }}
        install-node-modules: false
        protoc: false

    - run: cp -r packages/desktop/samples/basic ${{ runner.temp }}/sample_app

    - name: Download artifact into the temp dir
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-desktop
        path: ${{ runner.temp }}/sample_app
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install the tarball
      run: |
        npm install file:package.tgz
      working-directory: ${{ runner.temp }}/sample_app

    - run: npm run dump
      working-directory: ${{ runner.temp }}/sample_app

    # TODO: Run `yarn serve` and check if the app doesn't show any error.

    - name: Check if electron-builder works
      run: npm run app:dir
      working-directory: ${{ runner.temp }}/sample_app

    - name: Update commit status
      if: always()
      shell: bash
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATE="success"
        else
          STATE="failure"
        fi
        gh api repos/${{ github.repository }}/statuses/${HEAD_SHA} \
          -X POST \
          -f state=${STATE} \
          -f context='${{ github.job }} (${{ matrix.os }})' \
          -f target_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HEAD_SHA: ${{ needs.get-build-info.outputs.head-sha }}

  deploy-browser-preview:
    needs: [get-build-info, e2e-browser, e2e-browser-browserstack]
    if: ${{ needs.get-build-info.result == 'success' && ( needs.get-build-info.outputs.pr-number != '' || success() ) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Deploy @stlite/browser to Cloudflare Pages for preview
    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}
      valid: ${{ needs.e2e-browser.result == 'success' && needs.e2e-browser-browserstack.result == 'success' }}
    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-browser
        path: ${{ runner.temp }}/artifacts/browser
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify artifact contents
      uses: ./.github/actions/verify-only-file
      with:
        directory: ${{ runner.temp }}/artifacts/browser
        filename: package.tgz

    - name: Verify artifact attestation
      uses: ./.github/actions/verify-artifact-attestation
      with:
        filepath: ${{ runner.temp }}/artifacts/browser/package.tgz
        expected-workflow-file: .github/workflows/test-build.yml
        expected-ref: ${{ needs.get-build-info.outputs.pr-number && format('refs/pull/{0}/merge', needs.get-build-info.outputs.pr-number) || format('refs/heads/{0}', needs.get-build-info.outputs.branch) }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - run: tar xzvf package.tgz
      working-directory: ${{ runner.temp }}/artifacts/browser

    - name: Deploy
      uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
      id: deploy
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: |
          pages deploy ${{ runner.temp }}/artifacts/browser/package/build --project-name=stlite-browser-preview --branch=${{ needs.get-build-info.outputs.branch }} --commit-hash=${{ needs.get-build-info.outputs.trigger-sha }}
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # TODO: unify with notify-cloudflare-pages-deployments
  # For now we separate it to run the notifications in parallel for faster notifications.
  # We need to introduce an incremental comment update mechanism to unify them.
  notify-browser-preview-deployments:
    needs: [get-build-info, deploy-browser-preview]
    if: ${{ needs.get-build-info.outputs.pr-number != '' && always() }}
    # always() is needed to notify even if e2e tests have failed.

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ needs.get-build-info.outputs.pr-number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const previewUrl = '${{ needs.deploy-browser-preview.outputs.url }}';
            const logUrl = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Deployment completed successfully ([log](${logUrl})).
            ${{ needs.deploy-browser-preview.outputs.valid != 'true' && '_**â›” However, the e2e tests have failed, so the preview build may be broken. Please check the test results above.**_' || '' }}

            - \`${previewUrl}/stlite.js\`
            - \`${previewUrl}/stlite.css\`

            \`\`\`html
            <!DOCTYPE html>
            <html lang="en">
              <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <title>Stlite Browser preview</title>
                <link rel="stylesheet" href="${previewUrl}/stlite.css" />
              </head>
              <body>
                <noscript>You need to enable JavaScript to run this app.</noscript>
                <div id="root"></div>
                <script type="module">
            import { mount } from "${previewUrl}/stlite.js"
            mount(
              {
                entrypoint: "streamlit_app.py",
                files: {
                  "streamlit_app.py": \`
            import streamlit as st
            st.write("Hello world")
            \`,
                },
                requirements: [],
              },
              document.getElementById("root"),
            );

                </script>
              </body>
            </html>
            \`\`\`
            `
            });

  deploy-react-preview:
    needs: [get-build-info]
    if: ${{ needs.get-build-info.result == 'success' && ( needs.get-build-info.outputs.pr-number != '' || success() ) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Deploy @stlite/react to Cloudflare Pages for preview
    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}
      valid: 'true'
    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-react
        path: ${{ runner.temp }}/artifacts/react
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify artifact contents
      uses: ./.github/actions/verify-only-file
      with:
        directory: ${{ runner.temp }}/artifacts/react
        filename: package.tgz

    - name: Verify artifact attestation
      uses: ./.github/actions/verify-artifact-attestation
      with:
        filepath: ${{ runner.temp }}/artifacts/react/package.tgz
        expected-workflow-file: .github/workflows/test-build.yml
        expected-ref: ${{ needs.get-build-info.outputs.pr-number && format('refs/pull/{0}/merge', needs.get-build-info.outputs.pr-number) || format('refs/heads/{0}', needs.get-build-info.outputs.branch) }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - run: tar xzvf package.tgz
      working-directory: ${{ runner.temp }}/artifacts/react

    - name: Deploy
      uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
      id: deploy
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: |
          pages deploy ${{ runner.temp }}/artifacts/react/package/build --project-name=stlite-react-preview --branch=${{ needs.get-build-info.outputs.branch }} --commit-hash=${{ needs.get-build-info.outputs.trigger-sha }}
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  notify-react-preview-deployments:
    needs: [get-build-info, deploy-react-preview]
    if: ${{ needs.get-build-info.outputs.pr-number != '' && always() }}

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ needs.get-build-info.outputs.pr-number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const previewUrl = '${{ needs.deploy-react-preview.outputs.url }}';
            const logUrl = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Deployment completed successfully ([log](${logUrl})).

            Importable URLs:
            - \`${previewUrl}/stlite.js\`
            - \`${previewUrl}/stlite.css\`

            \`\`\`tsx
            import { StliteApp, createKernel } from "${previewUrl}/stlite.js";
            import "${previewUrl}/stlite.css";
            \`\`\`
            `
            });

  deploy-docs-preview:
    needs: [get-build-info]
    if: ${{ needs.get-build-info.result == 'success' && ( needs.get-build-info.outputs.pr-number != '' || success() ) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Deploy @stlite/docs to Cloudflare Pages for preview
    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-docs
        path: ${{ runner.temp }}/artifacts/docs
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify artifact attestation
      uses: ./.github/actions/verify-artifact-attestation
      with:
        filepath: "${{ runner.temp }}/artifacts/docs/index.html" # XXX: Only index.html is verified because the verification command only supports a single file input, while it may be better to verify all files, which takes a longer time though.
        expected-workflow-file: .github/workflows/test-build.yml
        expected-ref: ${{ needs.get-build-info.outputs.pr-number && format('refs/pull/{0}/merge', needs.get-build-info.outputs.pr-number) || format('refs/heads/{0}', needs.get-build-info.outputs.branch) }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Deploy
      uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
      id: deploy
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: |
          pages deploy ${{ runner.temp }}/artifacts/docs --project-name=stlite-docs --branch=${{ needs.get-build-info.outputs.branch }} --commit-hash=${{ needs.get-build-info.outputs.trigger-sha }}
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  notify-docs-preview-deployments:
    needs: [get-build-info, deploy-docs-preview]
    if: ${{ needs.get-build-info.outputs.pr-number != '' && always() }}

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ needs.get-build-info.outputs.pr-number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const previewUrl = '${{ needs.deploy-docs-preview.outputs.url }}';
            const logUrl = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Deployment completed successfully ([log](${logUrl})).

            ${previewUrl}
            `
            });


  deploy-sharing:
    needs: get-build-info
    if: ${{ needs.get-build-info.outputs.branch }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Deploy @stlite/sharing to Cloudflare Pages
    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: stlite-sharing
          path: ${{ runner.temp }}/artifacts/sharing
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: |
            pages deploy ${{ runner.temp }}/artifacts/sharing --project-name=stlite-sharing --branch=${{ needs.get-build-info.outputs.branch }} --commit-hash=${{ needs.get-build-info.outputs.trigger-sha }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  deploy-sharing-editor:
    needs: [get-build-info, deploy-sharing]
    if: ${{ needs.get-build-info.outputs.branch }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Deploy @stlite/sharing-editor to Cloudflare Pages
    outputs:
      url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: stlite-sharing-editor
          path: ${{ runner.temp }}/artifacts/sharing-editor
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Inject SHARING_APP_URL
        run: |
          echo '${{ needs.deploy-sharing.outputs.url }}' > ${{ runner.temp }}/artifacts/sharing-editor/SHARING_APP_URL

      - name: Deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3.14.1
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ${{ runner.temp }}/artifacts/sharing-editor --project-name=stlite-sharing-editor --branch=${{ needs.get-build-info.outputs.branch }} --commit-hash=${{ needs.get-build-info.outputs.trigger-sha }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  notify-cloudflare-pages-deployments:
    needs: [get-build-info, deploy-sharing, deploy-sharing-editor]
    if: ${{ needs.get-build-info.outputs.pr-number != '' }}

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          PR_NUMBER: ${{ needs.get-build-info.outputs.pr-number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const sharingUrl = '${{ needs.deploy-sharing.outputs.url }}';
            const sharingEditorUrl = '${{ needs.deploy-sharing-editor.outputs.url }}';
            const logUrl = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `Deployment completed successfully ([log](${logUrl})).
            * Sharing App: ${sharingUrl}
            * Sharing Editor: ${sharingEditorUrl}
            `
            });

  publish-browser:
    needs: [get-build-info, get-changesets-publish-targets]
    if: ${{ needs.get-changesets-publish-targets.outputs.browser != '' }}

    permissions:
      contents: write  # Necessary for creating releases: https://github.com/softprops/action-gh-release#permissions
      id-token: write  # Necessary for NPM trusted publishing: https://docs.npmjs.com/trusted-publishers#step-2-configure-your-cicd-workflow
      attestations: read  # Necessary for verifying artifact attestations

    runs-on: ubuntu-latest

    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: 22
        registry-url: 'https://registry.npmjs.org'
        scope: '@stlite'

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-browser
        path: ${{ runner.temp }}/stlite-browser
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify artifact contents
      uses: ./.github/actions/verify-only-file
      with:
        directory: ${{ runner.temp }}/stlite-browser
        filename: package.tgz

    - name: Verify artifact attestation
      uses: ./.github/actions/verify-artifact-attestation
      with:
        filepath: ${{ runner.temp }}/stlite-browser/package.tgz
        expected-workflow-file: .github/workflows/test-build.yml
        expected-ref: refs/heads/main
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Ensure npm 11.5.1 or later is installed
    - name: Update npm
      run: npm install -g npm@latest

    - name: Publish validated package
      run: npm publish ${{ runner.temp }}/stlite-browser/package.tgz --access public

    - name: Create a new release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: ${{ runner.temp }}/stlite-browser/package.tgz
        generate_release_notes: true
        tag_name: "@stlite/browser@${{ needs.get-changesets-publish-targets.outputs.browser }}"

  publish-react:
    needs: [get-build-info, get-changesets-publish-targets]
    if: ${{ needs.get-changesets-publish-targets.outputs.react != '' }}

    permissions:
      contents: write  # Necessary for creating releases: https://github.com/softprops/action-gh-release#permissions
      id-token: write  # Necessary for NPM trusted publishing: https://docs.npmjs.com/trusted-publishers#step-2-configure-your-cicd-workflow
      attestations: read  # Necessary for verifying artifact attestations

    runs-on: ubuntu-latest

    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: 22
        registry-url: 'https://registry.npmjs.org'
        scope: '@stlite'

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-react
        path: ${{ runner.temp }}/stlite-react
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify artifact contents
      uses: ./.github/actions/verify-only-file
      with:
        directory: ${{ runner.temp }}/stlite-react
        filename: package.tgz

    - name: Verify artifact attestation
      uses: ./.github/actions/verify-artifact-attestation
      with:
        filepath: ${{ runner.temp }}/stlite-react/package.tgz
        expected-workflow-file: .github/workflows/test-build.yml
        expected-ref: refs/heads/main
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Ensure npm 11.5.1 or later is installed
    - name: Update npm
      run: npm install -g npm@latest

    - name: Publish validated package
      run: npm publish ${{ runner.temp }}/stlite-react/package.tgz --access public

    - name: Create a new release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: ${{ runner.temp }}/stlite-react/package.tgz
        generate_release_notes: true
        tag_name: "@stlite/react@${{ needs.get-changesets-publish-targets.outputs.react }}"

  publish-desktop:
    needs: [get-build-info, get-changesets-publish-targets]
    if: ${{ needs.get-changesets-publish-targets.outputs.desktop != '' }}

    permissions:
      contents: write  # Necessary for creating releases: https://github.com/softprops/action-gh-release#permissions
      id-token: write  # Necessary for NPM trusted publishing: https://docs.npmjs.com/trusted-publishers#step-2-configure-your-cicd-workflow
      attestations: read  # Necessary for verifying artifact attestations

    runs-on: ubuntu-latest

    steps:
    # Checkout for local actions (`uses ./*`).
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false
        sparse-checkout: .github
        sparse-checkout-cone-mode: false

    - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: 22
        registry-url: 'https://registry.npmjs.org'
        scope: '@stlite'

    - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: stlite-desktop
        path: ${{ runner.temp }}/stlite-desktop
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify artifact contents
      uses: ./.github/actions/verify-only-file
      with:
        directory: ${{ runner.temp }}/stlite-desktop
        filename: package.tgz

    - name: Verify artifact attestation
      uses: ./.github/actions/verify-artifact-attestation
      with:
        filepath: ${{ runner.temp }}/stlite-desktop/package.tgz
        expected-workflow-file: .github/workflows/test-build.yml
        expected-ref: refs/heads/main
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Ensure npm 11.5.1 or later is installed
    - name: Update npm
      run: npm install -g npm@latest

    - name: Publish validated package
      run: npm publish ${{ runner.temp }}/stlite-desktop/package.tgz --access public

    - name: Create a new release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: ${{ runner.temp }}/stlite-desktop/package.tgz
        generate_release_notes: true
        tag_name: "@stlite/desktop@${{ needs.get-changesets-publish-targets.outputs.desktop }}"
